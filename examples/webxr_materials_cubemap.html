<!DOCTYPE html>
<html lang="en">
	<head>
		<title>VR Test App - WebXR - WaltHead Material Test</title>
		<meta charset="utf-8">
		<meta name="viewport" content="width=device-width, user-scalable=no, minimum-scale=1.0, maximum-scale=1.0">
		<link type="text/css" rel="stylesheet" href="main.css">
	</head>
	<body>

		<div id="container"></div>
		<div id="info">
			<a href="https://threejs.org" target="_blank" rel="noopener">three.js</a> - cube mapping demo.<br />
			Texture by <a href="http://www.humus.name/index.php?page=Textures" target="_blank" rel="noopener">Humus</a>, Walt Disney head by <a href="http://davidoreilly.com/post/18087489343/disneyhead" target="_blank" rel="noopener">David OReilly</a>
		</div>

		<script type="module">

			import * as THREE from '../build/three.module.js';

			import Stats from './jsm/libs/stats.module.js';

			import { OrbitControls } from './jsm/controls/OrbitControls.js';
			import { OBJLoader } from './jsm/loaders/OBJLoader.js';
			import { VRButton } from './jsm/webxr/VRButton.js';
			import { XRControllerModelFactory } from './jsm/webxr/XRControllerModelFactory.js';
			import { controllers } from './jsm/libs/dat.gui.module.js';

			const clock = new THREE.Clock();

			let container, stats;

			let camera, scene, renderer;
			let raycaster, workingMatrix, workingVector;

			let pointLight;

			init();
			animate();

			function init() {

				container = document.createElement( 'div' );
				document.body.appendChild( container );

				camera = new THREE.PerspectiveCamera( 50, window.innerWidth / window.innerHeight, 0.1, 5000 );
				//camera.position.z = 2000;
				camera.position.set(0, 1.6, 0);

				//cubemap
				const path = 'textures/cube/SwedishRoyalCastle/';
				const format = '.jpg';
				const urls = [
					path + 'px' + format, path + 'nx' + format,
					path + 'py' + format, path + 'ny' + format,
					path + 'pz' + format, path + 'nz' + format
				];

				const reflectionCube = new THREE.CubeTextureLoader().load( urls );
				const refractionCube = new THREE.CubeTextureLoader().load( urls );
				refractionCube.mapping = THREE.CubeRefractionMapping;

				scene = new THREE.Scene();
				scene.background = reflectionCube;

				//lights
				const ambient = new THREE.AmbientLight( 0xffffff );
				scene.add( ambient );

				pointLight = new THREE.PointLight( 0xffffff, 2 );
				scene.add( pointLight );

				//materials
				const cubeMaterial3 = new THREE.MeshLambertMaterial( { color: 0xff6600, envMap: reflectionCube, combine: THREE.MixOperation, reflectivity: 0.3 } );
				const cubeMaterial2 = new THREE.MeshLambertMaterial( { color: 0xffee00, envMap: refractionCube, refractionRatio: 0.95 } );
				const cubeMaterial1 = new THREE.MeshLambertMaterial( { color: 0xffffff, envMap: reflectionCube } );

				//models
				const objLoader = new OBJLoader();

				objLoader.setPath( 'models/obj/walt/' );
				objLoader.load( 'WaltHead.obj', function ( object ) {

					const head = object.children[ 0 ];

					head.scale.multiplyScalar( 15 );
					head.position.y = 0;
					head.position.z = -2;
					head.material = cubeMaterial1;
					head.scale.set(0.02, 0.02, 0.02);

					const head2 = head.clone();
					head2.position.x = - 2;
					head2.material = cubeMaterial2;

					const head3 = head.clone();
					head3.position.x = 2;
					head3.material = cubeMaterial3;

					scene.add( head, head2, head3 );

				} );

				//renderer
				renderer = new THREE.WebGLRenderer({ antialias: true });
				renderer.setPixelRatio( window.devicePixelRatio );
				renderer.setSize( window.innerWidth, window.innerHeight );
				container.appendChild( renderer.domElement );

				// controller view
				raycaster = new THREE.Raycaster();
				workingMatrix = new THREE.Matrix4();
				workingVector = new THREE.Vector3();


				//controls
				//const controls = new OrbitControls( camera, renderer.domElement );
				//controls.enableZoom = false;
				//controls.enablePan = false;
				//controls.minPolarAngle = Math.PI / 4;
				//controls.maxPolarAngle = Math.PI / 1.5;

				setupXR();

				//stats
				stats = new Stats();
				container.appendChild( stats.dom );

				window.addEventListener( 'resize', onWindowResize );

			}

			function setupXR() {
				renderer.xr.enabled = true;
				document.body.appendChild(VRButton.createButton(renderer));

				this.controllers = buildControllers();
			}

			function buildControllers() {
				const controllerModelFactory = new XRControllerModelFactory();

				const geometry = new THREE.BufferGeometry().setFromPoints([
					new THREE.Vector3(0, 0, 0),
					new THREE.Vector3(0, 0, -1)
				]);
				const line = new THREE.Line(geometry);
				line.name = 'line';
				line.scale.z = 0;

				const controllers = [];
				for (let i = 0; i <= 1; i++) {
					const controller = renderer.xr.getController(i);
					controller.add(line.clone());
					controller.userData.selectPressed = false;
					scene.add(controller);
					controllers.push(controller);

					const grip = renderer.xr.getControllerGrip(i);
					grip.add(controllerModelFactory.createControllerModel(grip));
					scene.add(grip);
				}

				return controllers;
			}

			function handleController(controller) {

			}

			function onWindowResize() {

				camera.aspect = window.innerWidth / window.innerHeight;
				camera.updateProjectionMatrix();

				renderer.setSize( window.innerWidth, window.innerHeight );

			}

			function animate() {

				/*requestAnimationFrame( animate )*/;
				render();

			}

			function render() {
				stats.update();

				if (this.controllers) {
					this.controllers.forEach((controller) => {
						handleController(controller)
					});
				}

				renderer.render( scene, camera );
				renderer.setAnimationLoop(render);

			}

		</script>

	</body>
</html>
